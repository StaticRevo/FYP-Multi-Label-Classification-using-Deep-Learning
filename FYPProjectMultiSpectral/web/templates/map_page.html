{% extends "base.html" %}

{% block title %}Interactive Map - Image Prediction{% endblock %}

{% block content %}
  <h1>Sentinel-2 RGB Viewer</h1>
  <p>Click the map to fetch a 120x120 Sentinel-2 patch!</p>
  <div id="map" style="height: 500px; width: 80%; margin: 20px auto;"></div>
  <div id="image-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map').setView([35.9375, 14.3754], 11); // Malta coordinates and zoom level

        // Add Esri World Imagery (satellite view)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
            maxZoom: 19
        }).addTo(map);

        // Ensure the map renders correctly
        setTimeout(function() {
            map.invalidateSize();
        }, 100);

        var imageOverlay = null;

        // Function to fetch an image based on latitude and longitude
        function fetchImage(lat, lon) {
            var formData = new FormData();
            formData.append('lat', lat);
            formData.append('lon', lon);

            document.getElementById('image-container').innerHTML = 'Loading...';

            fetch('/get_image', {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (imageOverlay) {
                    map.removeLayer(imageOverlay);
                }
                imageOverlay = L.imageOverlay(data.image_url, data.bounds).addTo(map);
                map.fitBounds(data.bounds);
                document.getElementById('image-container').innerHTML = `
                    <img src="${data.image_url}" alt="RGB Image" style="max-width: 300px;">
                    <p>Multispectral TIFF saved as: ${data.tiff_file}</p>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('image-container').innerHTML = 'Error fetching image.';
            });
        }

        // Add a click event listener to the map
        map.on('click', function(e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            fetchImage(lat, lon);
        });
    });
</script>

{% endblock %}